name: EPUB Optimizer CI

on:
  push:
    branches: [ main ]
    paths:
      - 'lib/epub_optimizer.rb'
      - '.github/workflows/epub-optimizer.yml'
      - 'Gemfile'
  pull_request:
    branches: [ main ]
    paths:
      - 'lib/epub_optimizer.rb'
      - 'Gemfile'
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        ruby-version: ['3.0', '3.1', '3.2']
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Ruby ${{ matrix.ruby-version }}
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true
        
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick libmagickwand-dev
        
    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install imagemagick
        
    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install imagemagick.app
        
    - name: Install Ruby dependencies
      run: |
        bundle install || gem install mini_magick nokogiri parallel zip --no-document
        
    - name: Validate script syntax
      run: |
        ruby -c lib/epub_optimizer.rb || { echo "❌ Ruby syntax error"; exit 1; }
        echo "✅ Syntax validation passed"
        
    - name: Create test directory
      run: |
        mkdir -p test_files
        
    - name: Create basic test EPUB
      run: |
        cd test_files
        
        # Create minimal EPUB structure
        echo "application/epub+zip" > mimetype
        mkdir -p META-INF OEBPS
        
        cat > META-INF/container.xml << 'EOF'
<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>
EOF
        
        cat > OEBPS/content.opf << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId" version="2.0">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:title>Test EPUB for Optimization</dc:title>
    <dc:creator>Test Author</dc:creator>
    <dc:language>en</dc:language>
  </metadata>
  <manifest>
    <item id="chapter1" href="chapter1.xhtml" media-type="application/xhtml+xml"/>
    <item id="style" href="style.css" media-type="text/css"/>
  </manifest>
  <spine>
    <itemref idref="chapter1"/>
  </spine>
</package>
EOF
        
        cat > OEBPS/chapter1.xhtml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Chapter 1</title>
    <link rel="stylesheet" type="text/css" href="style.css"/>
</head>
<body>
    <h1>Chapter 1: The Beginning</h1>
    <p>This is a test chapter with some content to optimize.</p>
    <p>Here's another paragraph with more text for testing purposes.</p>
    <div class="highlight">This is a highlighted section.</div>
</body>
</html>
EOF
        
        cat > OEBPS/style.css << 'EOF'
body {
    font-family: serif;
    line-height: 1.6;
    margin: 2em;
}

h1 {
    color: #333;
    border-bottom: 2px solid #333;
}

.highlight {
    background-color: yellow;
    padding: 0.5em;
    border-radius: 4px;
}

p {
    margin-bottom: 1em;
    text-align: justify;
}
EOF
        
        # Create EPUB (zip without compression for mimetype)
        zip -0Xq basic_test.epub mimetype
        zip -Xrq basic_test.epub META-INF OEBPS/
        cd ..
        
    - name: Create test EPUB with images
      run: |
        cd test_files
        
        # Create a simple test image using ImageMagick
        convert -size 300x200 xc:skyblue -pointsize 30 -fill white -gravity center -annotate +0+0 "Test Image" cover.jpg
        
        # Update content.opf to include image
        cat > OEBPS/content.opf << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId" version="2.0">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:title>Test EPUB with Images</dc:title>
    <dc:creator>Test Author</dc:creator>
    <dc:language>en</dc:language>
  </metadata>
  <manifest>
    <item id="chapter1" href="chapter1.xhtml" media-type="application/xhtml+xml"/>
    <item id="style" href="style.css" media-type="text/css"/>
    <item id="cover" href="cover.jpg" media-type="image/jpeg"/>
  </manifest>
  <spine>
    <itemref idref="chapter1"/>
  </spine>
</package>
EOF
        
        # Update chapter to include image
        cat > OEBPS/chapter1.xhtml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Chapter 1</title>
    <link rel="stylesheet" type="text/css" href="style.css"/>
</head>
<body>
    <div class="cover-image">
        <img src="cover.jpg" alt="Test Cover Image"/>
    </div>
    <h1>Chapter 1: The Beginning</h1>
    <p>This is a test chapter with an image and content to optimize.</p>
    <p>Here's another paragraph with more text for testing purposes.</p>
    <div class="highlight">This is a highlighted section.</div>
</body>
</html>
EOF
        
        # Create EPUB with image
        zip -0Xq image_test.epub mimetype
        zip -Xrq image_test.epub META-INF OEBPS/ cover.jpg
        cd ..
        
    - name: Test local execution - Basic EPUB
      run: |
        ruby lib/epub_optimizer.rb test_files/basic_test.epub test_files/basic_test_optimized.epub
        
        # Check if optimized file exists and is smaller
        if [ -f "test_files/basic_test_optimized.epub" ]; then
          original_size=$(stat -f%z "test_files/basic_test.epub" 2>/dev/null || stat -c%s "test_files/basic_test.epub")
          optimized_size=$(stat -f%z "test_files/basic_test_optimized.epub" 2>/dev/null || stat -c%s "test_files/basic_test_optimized.epub")
          
          if [ $optimized_size -lt $original_size ]; then
            echo "✅ Basic EPUB optimization successful ($original_size → $optimized_size bytes)"
          else
            echo "⚠️  Basic EPUB optimization didn't reduce size ($original_size → $optimized_size bytes)"
          fi
        else
          echo "❌ Basic EPUB optimization failed - no output file"
          exit 1
        fi
        
    - name: Test local execution - EPUB with images
      run: |
        ruby lib/epub_optimizer.rb test_files/image_test.epub test_files/image_test_optimized.epub
        
        # Check if optimized file exists and is smaller
        if [ -f "test_files/image_test_optimized.epub" ]; then
          original_size=$(stat -f%z "test_files/image_test.epub" 2>/dev/null || stat -c%s "test_files/image_test.epub")
          optimized_size=$(stat -f%z "test_files/image_test_optimized.epub" 2>/dev/null || stat -c%s "test_files/image_test_optimized.epub")
          
          if [ $optimized_size -lt $original_size ]; then
            echo "✅ Image EPUB optimization successful ($original_size → $optimized_size bytes)"
          else
            echo "⚠️  Image EPUB optimization didn't reduce size ($original_size → $optimized_size bytes)"
          fi
        else
          echo "❌ Image EPUB optimization failed - no output file"
          exit 1
        fi
        
    - name: Test GitHub direct execution
      run: |
        curl -sSL https://raw.githubusercontent.com/7not-nico/ruby-epub/main/lib/epub_optimizer.rb | ruby - test_files/basic_test.epub test_files/github_test.epub
        
        if [ -f "test_files/github_test.epub" ]; then
          echo "✅ GitHub direct execution works"
        else
          echo "❌ GitHub direct execution failed"
          exit 1
        fi
        
    - name: Validate EPUB structure
      run: |
        # Test that optimized files are still valid EPUBs
        for epub in test_files/*_optimized.epub test_files/github_test.epub; do
          if [ -f "$epub" ]; then
            echo "Validating $epub..."
            
            # Check if it's a valid zip
            if unzip -t "$epub" > /dev/null 2>&1; then
              echo "✅ $epub is a valid ZIP archive"
            else
              echo "❌ $epub is not a valid ZIP archive"
              exit 1
            fi
            
            # Check for required EPUB files
            if unzip -l "$epub" | grep -q "mimetype"; then
              echo "✅ $epub has mimetype file"
            else
              echo "❌ $epub missing mimetype file"
              exit 1
            fi
          fi
        done
        
    - name: Performance benchmark
      run: |
        # Performance test - should complete within reasonable time
        start_time=$(date +%s)
        ruby lib/epub_optimizer.rb test_files/image_test.epub test_files/perf_test.epub
        end_time=$(date +%s)
        
        duration=$((end_time - start_time))
        if [ $duration -gt 60 ]; then
          echo "❌ Processing too slow: ${duration}s (should be < 60s)"
          exit 1
        else
          echo "✅ Performance acceptable: ${duration}s"
        fi
        
    - name: Test error handling
      run: |
        # Test with non-existent file (should not crash)
        ruby lib/epub_optimizer.rb nonexistent.epub output.epub || echo "✅ Gracefully handled non-existent file"
        
        # Test with no arguments (should show usage)
        ruby lib/epub_optimizer.rb || echo "✅ Gracefully handled no arguments"
        
        # Test with invalid EPUB (corrupted zip)
        echo "not a zip" > test_files/corrupted.epub
        ruby lib/epub_optimizer.rb test_files/corrupted.epub test_files/corrupted_output.epub || echo "✅ Gracefully handled corrupted EPUB"
        
    - name: Cleanup
      if: always()
      run: |
        rm -rf test_files/