name: EPUB Renamer CI

on:
  push:
    branches: [ main ]
    paths:
      - 'epub-renamer/**'
      - '.github/workflows/epub-renamer.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'epub-renamer/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        ruby-version: ['3.1', '3.2']
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Ruby ${{ matrix.ruby-version }}
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        
    - name: Install dependencies
      run: |
        gem install zip nokogiri --no-document
        
    - name: Validate scripts
      run: |
        # Check permissions
        test -x epub-renamer/epub-renamer || { echo "❌ epub-renamer not executable"; exit 1; }
        test -x epub-renamer/epub-renamer-github.sh || { echo "❌ epub-renamer-github.sh not executable"; exit 1; }
        
        # Check shebangs
        head -n1 epub-renamer/epub-renamer | grep -q "#!/usr/bin/env ruby" || { echo "❌ Wrong shebang"; exit 1; }
        head -n1 epub-renamer/epub-renamer-github.sh | grep -q "#!/bin/bash" || { echo "❌ Wrong shebang"; exit 1; }
        
        # Check syntax
        ruby -c epub-renamer/epub-renamer || { echo "❌ Ruby syntax error"; exit 1; }
        
        echo "✅ Scripts validated"
        
    - name: Create test EPUB
      run: |
        mkdir -p test
        cd test
        
        # Create minimal EPUB structure
        echo "application/epub+zip" > mimetype
        mkdir -p META-INF OEBPS
        
        cat > META-INF/container.xml << 'EOF'
<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>
EOF
        
        cat > OEBPS/content.opf << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId" version="2.0">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:title>Test Book Title</dc:title>
    <dc:creator>Test Author</dc:creator>
  </metadata>
  <manifest>
    <item id="chapter1" href="chapter1.xhtml" media-type="application/xhtml+xml"/>
  </manifest>
  <spine>
    <itemref idref="chapter1"/>
  </spine>
</package>
EOF
        
        cat > OEBPS/chapter1.xhtml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>Chapter 1</title></head>
<body><p>Test content</p></body>
</html>
EOF
        
        zip -r test.epub mimetype META-INF OEBPS/
        cd ..
        
    - name: Test local execution
      run: |
        ruby epub-renamer/epub-renamer test/test.epub
        
        # Check if renamed file exists
        if [ -f "test/Test Book Title - Test Author.epub" ]; then
          echo "✅ Local execution works"
        else
          echo "❌ Local execution failed"
          ls -la test/
          exit 1
        fi
        
    - name: Test GitHub runner
      run: |
        curl -sSL https://raw.githubusercontent.com/7not-nico/ruby-epub/main/epub-renamer/epub-renamer-github.sh | bash -s -- test/test.epub
        
    - name: Test batch processing
      run: |
        # Create multiple test files
        cp test/test.epub test/test2.epub
        cp test/test.epub test/test3.epub
        
        ruby epub-renamer/epub-renamer test/test*.epub
        
    - name: Test error handling
      run: |
        # Test with non-existent file (should not crash)
        ruby epub-renamer/epub-renamer nonexistent.epub || true
        
        # Test with no arguments
        ruby epub-renamer/epub-renamer || true
        
        echo "✅ Error handling works"
        
    - name: Performance check
      run: |
        # Simple performance test - should complete quickly
        start_time=$(date +%s)
        ruby epub-renamer/epub-renamer test/test.epub
        end_time=$(date +%s)
        
        duration=$((end_time - start_time))
        if [ $duration -gt 5 ]; then
          echo "❌ Processing too slow: ${duration}s"
          exit 1
        else
          echo "✅ Performance acceptable: ${duration}s"
        fi
        
    - name: Cleanup
      if: always()
      run: |
        rm -rf test/